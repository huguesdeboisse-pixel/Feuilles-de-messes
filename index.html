<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Feuille de Messe ‚Äì G√©n√©rateur</title>
<style>
  body {
    margin: 0;
    font-family: "Inter", system-ui, sans-serif;
    background: #f7f6f3;
    color: #1a1a1a;
  }
  header {
    background: #6f1d1b;
    color: white;
    padding: 1em;
    text-align: center;
    font-size: 1.5em;
    letter-spacing: 0.5px;
  }
  main {
    max-width: 900px;
    margin: 2em auto;
    background: white;
    padding: 2em;
    border-radius: 16px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
  }
  label {
    display: block;
    margin-top: 1em;
    font-weight: 600;
  }
  input, select, button {
    padding: 10px;
    margin-top: 5px;
    border-radius: 10px;
    border: 1px solid #ccc;
    width: 100%;
    font-size: 1em;
  }
  button {
    background: #6f1d1b;
    color: white;
    cursor: pointer;
    font-weight: 600;
    transition: 0.2s;
  }
  button:hover {
    background: #501312;
  }
  .cartouche {
    margin-top: 1em;
    padding: 0.8em;
    border-radius: 8px;
    color: white;
    text-align: center;
    font-weight: 600;
  }
  .violet { background: #6f42c1; }
  .blanc { background: #f8f9fa; color: #1a1a1a; }
  .vert { background: #198754; }
  .rouge { background: #b71c1c; }
  .section {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1em;
    margin-top: 1em;
  }
  .section h3 {
    margin-top: 0;
  }
  ul { list-style: none; padding: 0; }
  li { margin-bottom: 4px; }
  #feuille {
    margin-top: 2em;
    background: white;
    padding: 1.5em;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: none;
  }
</style>
</head>
<body>
  <header>Feuille de Messe ‚Äì G√©n√©rateur</header>
  <main>
    <label for="date">üìÖ Date de la messe :</label>
    <input type="date" id="date">

    <label for="rite">‚úùÔ∏è Rite :</label>
    <select id="rite">
      <option value="ordinaire">Forme ordinaire</option>
      <option value="extraordinaire">Forme extraordinaire</option>
    </select>

    <label for="carnet">üìò Carnet de chants :</label>
    <select id="carnet">
      <option value="">-- S√©lectionnez un carnet --</option>
      <option value="diocese-frejus-toulon.json">Dioc√®se de Fr√©jus-Toulon</option>
    </select>

    <div id="cartouche" class="cartouche"></div>

    <button id="generer">üé∂ G√©n√©rer les suggestions</button>
    <button id="btn-feuille" style="margin-top: 10px;">üìÑ G√©n√©rer la feuille de messe</button>

    <div id="suggestions"></div>
    <div id="feuille"></div>
  </main>

<script>
// ============================
// üîπ TEMPS LITURGIQUE
// ============================
function datePaques(annee) {
  const a = annee % 19, b = Math.floor(annee / 100), c = annee % 100;
  const d = Math.floor(b / 4), e = b % 4, f = Math.floor((b + 8) / 25);
  const g = Math.floor((b - f + 1) / 3);
  const h = (19 * a + b - d - g + 15) % 30;
  const i = Math.floor(c / 4), k = c % 4;
  const l = (32 + 2 * e + 2 * i - h - k) % 7;
  const m = Math.floor((a + 11 * h + 22 * l) / 451);
  const mois = Math.floor((h + l - 7 * m + 114) / 31);
  const jour = ((h + l - 7 * m + 114) % 31) + 1;
  return new Date(annee, mois - 1, jour);
}

function determinerTempsLiturgique(date) {
  const annee = date.getFullYear();
  const paques = datePaques(annee);
  const mercrediCendres = new Date(paques); mercrediCendres.setDate(paques.getDate() - 46);
  const pentecote = new Date(paques); pentecote.setDate(paques.getDate() + 49);
  const noel = new Date(annee, 11, 25);
  const avent = new Date(noel); avent.setDate(noel.getDate() - 28);

  if (date >= avent && date < noel) return "Avent";
  if (date >= noel && date < new Date(annee + 1, 0, 13)) return "No√´l";
  if (date >= mercrediCendres && date < paques) return "Car√™me";
  if (date >= paques && date < pentecote) return "Temps pascal";
  return "Temps ordinaire";
}

function couleurTemps(temps) {
  switch (temps) {
    case "Avent":
    case "Car√™me": return "violet";
    case "No√´l":
    case "Temps pascal": return "blanc";
    case "Temps ordinaire": return "vert";
    default: return "rouge";
  }
}

// ============================
// üîπ ANTIENNE MARIALE
// ============================
function antienneMariale(date) {
  const annee = date.getFullYear();
  const paques = datePaques(annee);
  const c2fev = new Date(annee, 1, 2);
  const mercSaint = new Date(paques); mercSaint.setDate(paques.getDate() - 4);
  const pentecote = new Date(paques); pentecote.setDate(paques.getDate() + 49);
  const trinite = new Date(paques); trinite.setDate(paques.getDate() + 56);
  const noel = new Date(annee, 11, 25);
  const avent = new Date(noel); avent.setDate(noel.getDate() - 28);

  if (date >= avent && date <= c2fev) return "Alma Redemptoris Mater";
  if (date > c2fev && date <= mercSaint) return "Ave Regina caelorum";
  if (date >= paques && date <= pentecote) return "Regina caeli";
  if (date > pentecote && date < avent) return "Salve Regina";
  return "Salve Regina";
}

// ============================
// üîπ CHARGEMENT DES CHANTS
// ============================
async function chargerChants(temps, carnet, rite) {
  const r = await fetch("carnets/" + carnet);
  const data = await r.json();
  const chants = data.chants || [];

  // Cat√©gories selon le rite
  const categories = rite === "ordinaire"
    ? ["Chant d‚Äôentr√©e", "Psaume responsorial", "Acclamation de l‚Äô√âvangile", "Sanctus", "Anamn√®se", "Agnus Dei", "Chant de communion"]
    : ["Intro√Øt", "Graduel", "All√©luia (ou Trait)", "Offertoire", "Communion", "Antienne mariale"];

  const suggestions = {};
  for (const part of categories) {
    const chantsFiltres = chants.filter(c => c.temps?.includes(temps) && c.parties?.includes(part));
    suggestions[part] = chantsFiltres.sort(() => Math.random() - 0.5).slice(0, 3);
  }

  // Cas sp√©cial : antienne mariale automatique
  if (rite === "extraordinaire") {
    const antienne = antienneMariale(new Date());
    suggestions["Antienne mariale"] = [{ titre: antienne }];
  }

  return suggestions;
}

// ============================
// üîπ √âV√âNEMENTS
// ============================
document.getElementById("generer").addEventListener("click", async () => {
  const dateInput = document.getElementById("date").value;
  const rite = document.getElementById("rite").value;
  const carnet = document.getElementById("carnet").value;
  if (!dateInput || !carnet) {
    alert("Veuillez s√©lectionner une date et un carnet.");
    return;
  }

  const date = new Date(dateInput);
  const temps = determinerTempsLiturgique(date);
  const couleur = couleurTemps(temps);
  const cartouche = document.getElementById("cartouche");
  cartouche.className = "cartouche " + couleur;
  cartouche.textContent = `${temps} (${rite === "extraordinaire" ? "forme extraordinaire" : "forme ordinaire"})`;

  const data = await chargerChants(temps, carnet, rite);

  const div = document.getElementById("suggestions");
  div.innerHTML = "";
  for (const [partie, chants] of Object.entries(data)) {
    const section = document.createElement("div");
    section.className = "section";
    section.innerHTML = `<h3>${partie}</h3>`;
    const ul = document.createElement("ul");
    if (chants.length > 0) {
      chants.forEach(c => {
        const li = document.createElement("li");
        li.textContent = `${c.numero ? c.numero + ". " : ""}${c.titre}`;
        ul.appendChild(li);
      });
    } else {
      ul.innerHTML = "<li>Aucun chant trouv√©.</li>";
    }
    section.appendChild(ul);
    div.appendChild(section);
  }
});

// ============================
// üîπ G√âN√âRATION DE LA FEUILLE
// ============================
document.getElementById("btn-feuille").addEventListener("click", () => {
  const date = document.getElementById("date").value;
  const rite = document.getElementById("rite").value;
  const cartouche = document.getElementById("cartouche").textContent;
  const suggestions = document.getElementById("suggestions").innerHTML;
  const feuille = document.getElementById("feuille");
  feuille.innerHTML = `
    <h2>Feuille de messe du ${date}</h2>
    <p><strong>${cartouche}</strong></p>
    ${suggestions}
  `;
  feuille.style.display = "block";
});
</script>
</body>
</html>
