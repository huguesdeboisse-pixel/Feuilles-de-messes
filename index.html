<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Feuille de Messe ‚Äì Dioc√®se de Fr√©jus-Toulon</title>
  <style>
    body {
      font-family: "Inter", sans-serif;
      background: #f5f5f5;
      color: #222;
      margin: 0;
      padding: 0;
    }

    header {
      background: linear-gradient(135deg, #3b3b3b, #000);
      color: white;
      text-align: center;
      padding: 2rem 1rem 1rem 1rem;
      font-style: italic;
    }

    header p {
      margin: 0.5rem 0 0;
      font-size: 1rem;
      font-style: normal;
      color: #d3d3d3;
    }

    main {
      max-width: 900px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    h2 {
      border-bottom: 2px solid #ddd;
      padding-bottom: 0.3rem;
      margin-bottom: 1rem;
      color: #8b0000;
    }

    label {
      display: block;
      margin-top: 1rem;
      font-weight: bold;
    }

    select, input[type="date"] {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-top: 0.5rem;
      font-size: 1rem;
    }

    button {
      margin-top: 1rem;
      padding: 0.8rem 1.2rem;
      background: #8b0000;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #a52a2a;
    }

    .divider {
      border-top: 3px solid #8b0000;
      margin: 2rem 0;
    }

    .partie {
      margin-top: 2rem;
      padding: 1rem;
      border: 1px solid #eee;
      border-radius: 10px;
      background: #fafafa;
    }

    .chant {
      background: #f2f2f2;
      border-radius: 8px;
      padding: 0.6rem 1rem;
      margin: 0.4rem 0;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .chant:hover {
      background: #e6e6e6;
    }

    .chant.selected {
      background: #d8e4f5;
      border: 1px solid #90b4e0;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }

    .partie h3 {
      margin-top: 0;
      color: #333;
    }

    .sous-btn {
      background: #555;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      border-radius: 6px;
    }

    .sous-btn:hover {
      background: #777;
    }
  </style>
</head>

<body>
  <header>
    <div>¬´ Le but de la musique devrait n'√™tre que la gloire de Dieu et le d√©lassement des √¢mes. ¬ª</div>
    <p>Johann Sebastian Bach</p>
  </header>

  <main>
    <section id="parametres">
      <h2>Param√®tres</h2>
      <label for="select-rite">Choisissez le rite :</label>
      <select id="select-rite">
        <option value="ordinaire">Forme ordinaire du rite romain</option>
        <option value="extraordinaire">Forme extraordinaire du rite romain</option>
      </select>

      <label for="date">Date de la messe :</label>
      <input type="date" id="date" />

      <p id="temps-liturgique" style="margin-top:1rem; font-style:italic;"></p>
    </section>

    <div class="divider"></div>

    <section id="resultats">
      <h2>Suggestions de chants</h2>
      <div id="suggestions"></div>
      <button id="generer">G√©n√©rer la feuille de messe</button>
    </section>
  </main>

  <script>
    // =============== OUTILS LITURGIQUES ===============
    function datePaques(annee) {
      const a = annee % 19, b = Math.floor(annee / 100), c = annee % 100,
            d = Math.floor(b / 4), e = b % 4, f = Math.floor((b + 8) / 25),
            g = Math.floor((b - f + 1) / 3),
            h = (19 * a + b - d - g + 15) % 30,
            i = Math.floor(c / 4), k = c % 4,
            l = (32 + 2 * e + 2 * i - h - k) % 7,
            m = Math.floor((a + 11 * h + 22 * l) / 451),
            mois = Math.floor((h + l - 7 * m + 114) / 31),
            jour = ((h + l - 7 * m + 114) % 31) + 1;
      return new Date(annee, mois - 1, jour);
    }

    function determinerTempsLiturgique(date = new Date()) {
      const annee = date.getFullYear();
      const paques = datePaques(annee);
      const mercrediCendres = new Date(paques);
      mercrediCendres.setDate(paques.getDate() - 46);
      const noel = new Date(annee, 11, 25);
      const avent = new Date(noel);
      avent.setDate(noel.getDate() - 21);

      if (date >= avent && date < noel) return "Avent";
      if (date >= noel && date < new Date(annee + 1, 0, 13)) return "No√´l";
      if (date >= mercrediCendres && date < paques) return "Car√™me";
      const pentecote = new Date(paques);
      pentecote.setDate(paques.getDate() + 49);
      if (date >= paques && date < pentecote) return "Temps pascal";
      return "Temps ordinaire";
    }

    function couleurTempsLiturgique(temps) {
      switch (temps) {
        case "Avent":
        case "Car√™me": return "#6A0DAD";
        case "No√´l":
        case "Temps pascal": return "#D4AF37";
        case "Temps ordinaire": return "#006400";
        default: return "#B22222";
      }
    }

    // =============== GESTION DU CARNET ===============
    async function chargerCarnet() {
      const response = await fetch("carnets/diocese-frejus-toulon-classe.json");
      return await response.json();
    }

    const selectionsUtilisateur = {};

    // =============== G√âN√âRATION DES SUGGESTIONS ===============
    async function genererSuggestions() {
      const rite = document.getElementById("select-rite").value;
      const date = new Date(document.getElementById("date").value);
      const temps = determinerTempsLiturgique(date);
      document.getElementById("temps-liturgique").textContent = `Temps liturgique : ${temps}`;

      const data = await chargerCarnet();
      const chants = data.chants.filter(c => c.temps.includes(temps));

      const parties = rite === "ordinaire"
        ? ["Chant d‚Äôentr√©e", "Psaume responsorial", "Acclamation de l‚Äô√âvangile", "Sanctus", "Anamn√®se", "Agnus Dei", "Chant de communion"]
        : ["Intro√Øt", "Graduel", "All√©luia (ou Trait)", "Offertoire", "Communion", "Antienne mariale"];

      const partieEntree = rite === "ordinaire" ? "Chant d‚Äôentr√©e" : "Intro√Øt";
      const container = document.getElementById("suggestions");
      container.innerHTML = "";

      for (const partie of parties) {
        const div = document.createElement("div");
        div.className = "partie";
        div.dataset.partie = partie;
        div.innerHTML = `<h3>${partie}</h3>`;

        const btn = document.createElement("button");
        btn.className = "sous-btn";
        btn.textContent = "üîÑ Nouvelles suggestions";
        btn.onclick = () => rafraichirSuggestions(partie, chants, partieEntree);

        const bloc = document.createElement("div");
        bloc.className = "liste-chants";
        bloc.dataset.partie = partie;
        div.appendChild(bloc);
        div.appendChild(btn);

        container.appendChild(div);
        rafraichirSuggestions(partie, chants, partieEntree);
      }
    }

    function rafraichirSuggestions(partie, chants, partieEntree) {
      const bloc = document.querySelector(`.liste-chants[data-partie="${partie}"]`);
      if (!bloc) return;
      bloc.innerHTML = "";

      const selected = selectionsUtilisateur[partie];
      let subset = chants.filter(c => c.parties.includes(partie));
      if (subset.length === 0) subset = chants.filter(c => c.parties.includes(partieEntree));

      subset = melanger(subset).slice(0, 3);

      if (selected) {
        subset = [selected, ...subset.filter(c => c.titre !== selected.titre).slice(0, 2)];
      }

      subset.forEach(c => {
        const el = document.createElement("div");
        el.className = "chant";
        el.textContent = `${c.titre} (p. ${c.page || "?"})`;
        if (selected && selected.titre === c.titre) el.classList.add("selected");
        el.onclick = () => toggleSelection(partie, c, el, bloc);
        bloc.appendChild(el);
      });
    }

    function toggleSelection(partie, chant, el, bloc) {
      const deja = selectionsUtilisateur[partie];
      selectionsUtilisateur[partie] = deja && deja.titre === chant.titre ? null : chant;
      bloc.querySelectorAll(".chant").forEach(c => c.classList.remove("selected"));
      if (selectionsUtilisateur[partie]) el.classList.add("selected");
    }

    function melanger(arr) {
      return arr.sort(() => Math.random() - 0.5);
    }

    // =============== FEUILLE DE MESSE ===============
    function dateEnLettres(dateStr) {
      const d = new Date(dateStr);
      const options = { weekday: "long", year: "numeric", month: "long", day: "numeric" };
      return d.toLocaleDateString("fr-FR", options);
    }

    function genererFeuille() {
      const dateStr = document.getElementById("date").value;
      const temps = document.getElementById("temps-liturgique").textContent.split(": ")[1];
      const couleur = couleurTempsLiturgique(temps);

      const contenu = Object.entries(selectionsUtilisateur)
        .map(([partie, chant]) =>
          `<h3>${partie}</h3><div class="chant">${chant ? chant.titre : "<em>Aucun chant s√©lectionn√©</em>"}</div>`
        ).join("");

      const page = window.open("", "_blank");
      page.document.write(`
        <html>
        <head>
          <title>Feuille de Messe</title>
          <style>
            @page { size: A4; margin: 2cm; }
            body { font-family: "Georgia", serif; background: white; color: #111; margin: 2rem; }
            h1 { text-align: center; font-size: 2rem; margin-bottom: 0.5rem; }
            .date {
              text-align: center;
              background: ${couleur};
              color: white;
              padding: 0.4rem 0.8rem;
              border-radius: 8px;
              display: inline-block;
              margin: 0 auto;
              font-weight: bold;
            }
            h3 { border-bottom: 2px solid #444; padding-bottom: 0.2rem; margin-top: 1rem; }
            .chant { margin-left: 1rem; }
          </style>
        </head>
        <body>
          <h1>Feuille de Messe</h1>
          <div class="date">${dateEnLettres(dateStr)}</div>
          <p style="text-align:center; font-style:italic; margin-top:0.5rem;">${temps}</p>
          ${contenu}
        </body>
        </html>
      `);
      page.document.close();
    }

    // =============== INITIALISATION ===============
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("date").valueAsDate = new Date();
      document.getElementById("select-rite").addEventListener("change", genererSuggestions);
      document.getElementById("date").addEventListener("change", genererSuggestions);
      document.getElementById("generer").addEventListener("click", genererFeuille);
      genererSuggestions();
    });
  </script>
</body>
</html>
