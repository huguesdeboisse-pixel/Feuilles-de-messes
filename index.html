<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Feuille de Messe</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 40px;
      color: #222;
    }

    select, p {
      font-size: 1rem;
      margin-top: 10px;
    }

    #affichage-temps {
      padding: 10px 15px;
      border-radius: 10px;
      font-weight: 600;
      color: white;
      display: inline-block;
      margin-top: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: background 0.3s ease;
    }

    #menu-chants {
      display: block;
      margin-top: 20px;
      min-width: 250px;
    }
  </style>
</head>

<body>
  <h2>üéµ Feuille de Messe</h2>

  <!-- S√©lecteur du rite -->
  <label for="select-rite">Choisissez le rite :</label>
  <select id="select-rite">
    <option value="ordinaire">Rite romain ordinaire</option>
    <option value="extraordinaire">Rite romain extraordinaire</option>
  </select>

  <br><br>

  <!-- S√©lecteur du carnet -->
  <label for="select-carnet">Choisissez un carnet :</label>
  <select id="select-carnet">
    <option value="">-- S√©lectionnez un carnet --</option>
    <option value="diocese-frejus-toulon.json">Dioc√®se de Fr√©jus-Toulon</option>
  </select>

  <p id="affichage-temps"></p>

  <select id="menu-chants">
    <option>-- S√©lectionnez un chant --</option>
  </select>

  <!-- ============================ -->
  <!-- üí° SCRIPT PRINCIPAL ICI -->
  <!-- ============================ -->
  <script>
  // ===========================
  // üîπ CALCUL DU TEMPS LITURGIQUE
  // ===========================

  function datePaques(annee) {
    const a = annee % 19;
    const b = Math.floor(annee / 100);
    const c = annee % 100;
    const d = Math.floor(b / 4);
    const e = b % 4;
    const f = Math.floor((b + 8) / 25);
    const g = Math.floor((b - f + 1) / 3);
    const h = (19 * a + b - d - g + 15) % 30;
    const i = Math.floor(c / 4);
    const k = c % 4;
    const l = (32 + 2 * e + 2 * i - h - k) % 7;
    const m = Math.floor((a + 11 * h + 22 * l) / 451);
    const mois = Math.floor((h + l - 7 * m + 114) / 31);
    const jour = ((h + l - 7 * m + 114) % 31) + 1;
    return new Date(annee, mois - 1, jour);
  }

  function determinerTempsLiturgique(date = new Date(), rite = "ordinaire") {
    const annee = date.getFullYear();
    const paques = datePaques(annee);

    const mercrediCendres = new Date(paques); mercrediCendres.setDate(paques.getDate() - 46);
    const pentecote = new Date(paques); pentecote.setDate(paques.getDate() + 49);

    const noel = new Date(annee, 11, 25);
    const avent = new Date(noel);
    avent.setDate(noel.getDate() - (noel.getDay() + 21));

    const noelFin = new Date(annee + (noel.getMonth() === 11 ? 1 : 0), 0, 13);

    if (date >= avent && date < noel) return "Avent";
    if (date >= noel && date <= noelFin) return "No√´l";
    if (date >= mercrediCendres && date < paques) return "Car√™me";
    if (date >= paques && date < pentecote) return "Temps pascal";
    if (date >= pentecote && date < avent) return "Temps ordinaire";
    return "Temps ordinaire";
  }

  // ===========================
  // üîπ ASSIGNATION DES COULEURS
  // ===========================

  function couleurLiturgique(temps) {
    switch (temps) {
      case "Avent":
      case "Car√™me":
        return "#6f42c1"; // violet
      case "No√´l":
      case "Temps pascal":
        return "#f8f9fa"; // blanc
      case "Temps ordinaire":
        return "#198754"; // vert
      default:
        return "#dc3545"; // rouge
    }
  }

  // ===========================
  // üîπ CHARGEMENT DES CHANTS
  // ===========================
  async function chargerChantsLiturgiques() {
    try {
      const selectRite = document.getElementById("select-rite");
      const rite = selectRite ? selectRite.value : "ordinaire";

      const selectCarnet = document.getElementById("select-carnet");
      const carnetFichier = selectCarnet ? selectCarnet.value : null;

      const menu = document.getElementById("menu-chants");
      const affichage = document.getElementById("affichage-temps");

      if (!carnetFichier) {
        affichage.textContent = "Veuillez choisir un carnet.";
        affichage.style.background = "#999";
        return;
      }

      const dateDuJour = new Date();
      const tempsLiturgique = determinerTempsLiturgique(dateDuJour, rite);
      const couleur = couleurLiturgique(tempsLiturgique);

      affichage.textContent = `${tempsLiturgique} (${rite === "extraordinaire" ? "forme extraordinaire" : "forme ordinaire"})`;
      affichage.style.background = couleur;
      affichage.style.color = (couleur === "#f8f9fa") ? "#222" : "#fff";

      // Lecture du fichier JSON du carnet s√©lectionn√©
      const response = await fetch(carnetFichier);
      const data = await response.json();

      // On filtre les chants correspondant au temps liturgique
      const chants = data.chants.filter(c => 
        (c.temps && c.temps.includes(tempsLiturgique)) || !c.temps
      );

      if (chants.length === 0) {
        menu.innerHTML = `<option>Aucun chant trouv√© pour ${tempsLiturgique}</option>`;
        return;
      }

      menu.innerHTML = chants
        .map(c => `<option>${c.numero}. ${c.titre}</option>`)
        .join("");

      console.log(`‚úÖ ${chants.length} chants charg√©s depuis ${carnetFichier} (${tempsLiturgique})`);
    } catch (err) {
      console.error("Erreur lors du chargement des chants :", err);
    }
  }

  // ===========================
  // üîπ INITIALISATION
  // ===========================
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("select-rite").addEventListener("change", chargerChantsLiturgiques);
    document.getElementById("select-carnet").addEventListener("change", chargerChantsLiturgiques);
  });
  </script>
</body>
</html>
