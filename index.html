<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Feuille de Messe ‚Äì Dioc√®se de Fr√©jus-Toulon</title>
  <style>
    body {
      font-family: "Inter", sans-serif;
      background: #f7f7f7;
      color: #222;
      margin: 0;
      padding: 0;
    }

    header {
      background: linear-gradient(135deg, #8b0000, #b22222);
      color: white;
      text-align: center;
      padding: 1.5rem 1rem;
    }

    main {
      max-width: 800px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    h1 {
      margin: 0;
      font-size: 1.8rem;
    }

    label {
      display: block;
      margin-top: 1rem;
      font-weight: bold;
    }

    select, input[type="date"] {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-top: 0.5rem;
      font-size: 1rem;
    }

    button {
      margin-top: 1.5rem;
      padding: 0.8rem 1.2rem;
      background: #8b0000;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #a52a2a;
    }

    .partie {
      margin-top: 1.5rem;
    }

    .chant {
      background: #f0f0f0;
      border-radius: 8px;
      padding: 0.5rem 1rem;
      margin: 0.3rem 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>Feuille de Messe</h1>
    <p>Dioc√®se de Fr√©jus-Toulon</p>
  </header>

  <main>
    <label for="select-rite">Choisissez le rite :</label>
    <select id="select-rite">
      <option value="ordinaire">Forme ordinaire du rite romain</option>
      <option value="extraordinaire">Forme extraordinaire du rite romain</option>
    </select>

    <label for="date">Date de la messe :</label>
    <input type="date" id="date" value="" />

    <p id="temps-liturgique" style="margin-top:1rem; font-style:italic;"></p>

    <div id="suggestions"></div>

    <button id="generer">G√©n√©rer la feuille de messe</button>
  </main>

  <script>
    // =============================
    // üîπ Calcul du temps liturgique
    // =============================

    function datePaques(annee) {
      const a = annee % 19;
      const b = Math.floor(annee / 100);
      const c = annee % 100;
      const d = Math.floor(b / 4);
      const e = b % 4;
      const f = Math.floor((b + 8) / 25);
      const g = Math.floor((b - f + 1) / 3);
      const h = (19 * a + b - d - g + 15) % 30;
      const i = Math.floor(c / 4);
      const k = c % 4;
      const l = (32 + 2 * e + 2 * i - h - k) % 7;
      const m = Math.floor((a + 11 * h + 22 * l) / 451);
      const mois = Math.floor((h + l - 7 * m + 114) / 31);
      const jour = ((h + l - 7 * m + 114) % 31) + 1;
      return new Date(annee, mois - 1, jour);
    }

    function determinerTempsLiturgique(date = new Date(), rite = "ordinaire") {
      const annee = date.getFullYear();
      const paques = datePaques(annee);

      const mercrediCendres = new Date(paques);
      mercrediCendres.setDate(paques.getDate() - 46);
      const noel = new Date(annee, 11, 25);
      const avent = new Date(noel);
      avent.setDate(noel.getDate() - 21);

      if (date >= avent && date < noel) return "Avent";
      if (date >= noel && date < new Date(annee + 1, 0, 13)) return "No√´l";
      if (date >= mercrediCendres && date < paques) return "Car√™me";
      const pentecote = new Date(paques);
      pentecote.setDate(paques.getDate() + 49);
      if (date >= paques && date < pentecote) return "Temps pascal";
      return "Temps ordinaire";
    }

    // =============================
    // üîπ Chargement du carnet
    // =============================

    async function chargerCarnet() {
      const response = await fetch("carnets/diocese-frejus-toulon-classe.json");
      return await response.json();
    }

    // =============================
    // üîπ G√©n√©ration des suggestions
    // =============================

    async function genererSuggestions() {
      const rite = document.getElementById("select-rite").value;
      const date = new Date(document.getElementById("date").value);
      const temps = determinerTempsLiturgique(date, rite);

      document.getElementById("temps-liturgique").textContent =
        `Temps liturgique : ${temps}`;

      const data = await chargerCarnet();
      const chants = data.chants.filter(c => c.temps.includes(temps));

      const parties =
        rite === "ordinaire"
          ? ["Chant d‚Äôentr√©e", "Psaume responsorial", "Acclamation de l‚Äô√âvangile", "Sanctus", "Anamn√®se", "Agnus Dei", "Chant de communion"]
          : ["Intro√Øt", "Graduel", "All√©luia (ou Trait)", "Offertoire", "Communion", "Antienne mariale"];

      const container = document.getElementById("suggestions");
      container.innerHTML = "";

      for (const partie of parties) {
        const div = document.createElement("div");
        div.className = "partie";
        div.innerHTML = `<h3>${partie}</h3>`;
        const subset = chants.filter(c => c.parties.includes(partie)).slice(0, 3);
        if (subset.length === 0) {
          div.innerHTML += "<p><em>Aucun chant trouv√© pour cette partie.</em></p>";
        } else {
          subset.forEach(c => {
            const p = document.createElement("div");
            p.className = "chant";
            p.textContent = `${c.titre} (p. ${c.page || "?"})`;
            div.appendChild(p);
          });
        }
        container.appendChild(div);
      }
    }

    // =============================
    // üîπ G√©n√©ration de la feuille de messe
    // =============================

    function genererFeuille() {
      const date = document.getElementById("date").value;
      const temps = document.getElementById("temps-liturgique").textContent;
      const contenu = document.getElementById("suggestions").innerHTML;

      const page = window.open("", "_blank");
      page.document.write(`
        <html>
        <head>
          <title>Feuille de Messe</title>
          <style>
            body { font-family: "Georgia", serif; background: white; color: #111; margin: 2rem; }
            h1 { text-align: center; }
            .partie h3 { border-bottom: 2px solid #444; padding-bottom: 0.2rem; margin-top: 1rem; }
            .chant { margin-left: 1rem; }
          </style>
        </head>
        <body>
          <h1>Feuille de Messe</h1>
          <p><strong>Date :</strong> ${date}</p>
          <p><strong>${temps}</strong></p>
          ${contenu}
        </body>
        </html>
      `);
      page.document.close();
    }

    // =============================
    // üîπ Initialisation
    // =============================

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("date").valueAsDate = new Date();
      document.getElementById("select-rite").addEventListener("change", genererSuggestions);
      document.getElementById("date").addEventListener("change", genererSuggestions);
      document.getElementById("generer").addEventListener("click", genererFeuille);
      genererSuggestions();
    });
  </script>
</body>
</html>
